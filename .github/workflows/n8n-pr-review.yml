---
name: N8N PR Review Comment Trigger

"on":
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read

jobs:
  trigger-n8n:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger N8N Workflow
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          REPOSITORY: ${{ github.repository }}
          COMMENT_CREATED_AT: ${{ github.event.comment.created_at }}
        run: |
          echo "PR Review Comment Event Triggered"
          echo "Action: ${{ github.event.action }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Comment Author: ${COMMENT_AUTHOR}"
          echo "Repository: ${REPOSITORY}"

          # Prepare payload for n8n webhook
          PAYLOAD=$(jq -n \
            --arg event "pull_request_review_comment" \
            --arg action "${{ github.event.action }}" \
            --arg repository "${REPOSITORY}" \
            --argjson pr_number "${{ github.event.pull_request.number }}" \
            --argjson comment_id "${{ github.event.comment.id }}" \
            --arg comment_body "${COMMENT_BODY}" \
            --arg comment_author "${COMMENT_AUTHOR}" \
            --arg comment_created_at "${COMMENT_CREATED_AT}" \
            --arg pr_title "${PR_TITLE}" \
            --arg pr_url "${PR_URL}" \
            '{
              event: $event,
              action: $action,
              repository: $repository,
              pr_number: $pr_number,
              comment: {
                id: $comment_id,
                body: $comment_body,
                author: $comment_author,
                created_at: $comment_created_at
              },
              pull_request: {
                title: $pr_title,
                html_url: $pr_url
              }
            }')

          echo "Prepared payload for n8n:"
          echo "$PAYLOAD" | jq .

          # Send to n8n webhook
          # (requires N8N_WEBHOOK_URL secret to be configured)
          if [ -n "${{ secrets.N8N_WEBHOOK_URL }}" ]; then
            echo "Sending to n8n webhook..."
            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "${{ secrets.N8N_WEBHOOK_URL }}"
            echo "Webhook call completed"
          else
            echo "N8N_WEBHOOK_URL secret not configured."
            echo "Skipping webhook call."
            echo "To enable n8n integration, add N8N_WEBHOOK_URL \
          as a repository secret."
          fi
